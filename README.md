# 影视文件管理系统

一个现代化的 Web 应用，用于自动管理影视文件并匹配种子下载。

## 功能特性

1. **智能文件扫描** - 扫描指定路径下的影视文件和文件夹，支持排除指定目录
2. **TMDB 集成** - 通过 TMDB API 自动识别影视作品类目，带频率限制和重试机制
3. **自动分类** - 根据识别结果自动创建类目文件夹并移动文件/文件夹
4. **文件夹支持** - 支持直接处理影视文件夹（如剧集季度文件夹）
5. **种子匹配** - 智能匹配种子文件与已分类的影视文件
6. **qBittorrent 集成** - 自动添加匹配的种子到 qBittorrent 下载器
7. **现代化界面** - 美观的 Web 界面，支持实时进度显示
8. **配置持久化** - 自动保存配置信息，重启后无需重新配置
9. **数据管理** - 记录已处理文件，支持数据重置和状态查看
10. **完整日志** - 详细的操作日志，便于调试和监控

## 安装要求

- Python 3.7+
- Flask 2.3.3
- requests 2.31.0

## 安装步骤

1. 克隆或下载项目文件
2. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
3. 运行应用：
   ```bash
   python movie_manager.py
   ```
4. 打开浏览器访问：http://localhost:5000

## 使用说明

### 首次运行

系统首次启动时会显示：

```
配置文件不存在，等待用户首次配置
数据文件不存在，将创建新的数据文件
```

这是正常现象，系统会等待您在 Web 界面中进行配置。配置完成后会自动保存到本地文件，下次启动时会自动加载。

### 第一步：配置 API

1. **配置 TMDB API**

   - 访问 [TMDB 官网](https://www.themoviedb.org/settings/api) 获取 API 密钥
   - 在界面中输入 API 密钥并点击"配置 TMDB"
   - 配置成功后会自动保存到 `movie_manager_config.json`

2. **配置 qBittorrent**
   - 确保 qBittorrent Web UI 已启用
   - 输入 qBittorrent 地址（如：http://localhost:8080）
   - 输入用户名和密码
   - 点击"配置 qBittorrent"
   - 配置成功后会自动保存到 `movie_manager_config.json`

### 第二步：扫描影视文件

1. 输入影视文件所在的根目录路径
2. （可选）输入要排除的目录名称，用逗号分隔
3. 点击"扫描文件"按钮
4. 系统会显示找到的所有视频文件和文件夹（只扫描第一层，不递归遍历）

### 第三步：自动分类文件

1. 点击"开始自动分类"按钮
2. 系统会：
   - 从文件名或文件夹名中提取影视作品标题
   - 通过 TMDB API 搜索匹配的作品（带频率限制和重试机制）
   - 根据搜索结果创建类目文件夹
   - 将文件或整个文件夹移动到对应的类目文件夹中
3. 查看分类结果，成功和失败的项目会分别显示

### 第四步：匹配种子文件

1. 输入种子文件夹路径
2. 点击"匹配种子"按钮
3. 系统会：
   - 扫描种子文件夹中的所有.torrent 文件
   - 与已分类的影视文件进行智能匹配
   - 显示匹配结果和相似度

### 第五步：添加种子下载

1. 查看匹配结果
2. 点击"批量添加种子"按钮
3. 系统会：
   - 将匹配的种子文件添加到 qBittorrent
   - 自动设置下载路径为对应的影视文件目录
   - 显示添加结果

### 系统管理

系统提供了额外的管理功能：

1. **重置数据**

   - 清空所有已处理文件的记录
   - 不会删除实际文件，只清空系统记录
   - 操作不可撤销，请谨慎使用

2. **刷新状态**

   - 重新检查配置状态
   - 显示当前已处理文件数量
   - 验证 API 连接状态

3. **自动保存**
   - 所有配置更改自动保存到 `movie_manager_config.json`
   - 文件处理记录自动保存到 `movie_manager_data.json`
   - 重启应用后自动恢复之前的状态

## 支持的文件格式

- 视频文件：.mp4, .mkv, .avi, .mov, .wmv, .flv, .webm, .m4v
- 种子文件：.torrent

## 注意事项

1. **文件移动操作不可逆**，建议先在测试目录中试用
2. 确保有足够的磁盘空间进行文件移动操作
3. **TMDB API 频率限制**：系统已内置 250ms 请求间隔和重试机制，大量文件处理时会自动控制速度
4. **文件夹处理**：支持直接处理影视文件夹，适合剧集和电影系列
5. qBittorrent 需要启用 Web UI 并配置正确的访问权限
6. 种子匹配基于文件名相似度，可能存在误匹配情况
7. **扫描优化**：只扫描第一层目录，提升大型目录的扫描速度

## 故障排除

### TMDB 配置失败

- 检查 API 密钥是否正确
- 确认网络连接正常
- 检查是否超出 API 请求限制

### qBittorrent 连接失败

- 确认 qBittorrent 正在运行
- 检查 Web UI 是否已启用
- 验证地址、用户名、密码是否正确
- 检查防火墙设置

### 文件扫描失败

- 确认路径存在且有读取权限
- 检查路径格式是否正确
- 确认目录中包含支持的视频文件

### 种子添加失败

- 检查 qBittorrent 连接状态
- 确认种子文件完整且未损坏
- 检查下载路径是否存在且有写入权限

## 技术架构

- **后端**：Flask Web 框架
- **前端**：Bootstrap 5 + 原生 JavaScript
- **API 集成**：TMDB API、qBittorrent Web API
- **文件操作**：Python 标准库

## 开发说明

项目结构：

```
movie_manager.py                    # 主应用文件
templates/
  └── index.html                   # Web界面模板
static/
  └── js/
      └── main.js                  # 前端JavaScript
requirements.txt                   # Python依赖
README.md                          # 说明文档
USAGE_EXAMPLE.md                   # 使用示例和日志展示
config.json.example                # 配置文件模板
movie_manager_config.json          # 自动生成的配置文件
movie_manager_data.json            # 自动生成的数据文件
```

## 许可证

本项目仅供学习和个人使用。请遵守相关法律法规，不要用于非法用途。

## 更新日志

### v1.1.0 - 2025-06-22

- **文件夹支持**：新增文件夹处理功能，支持剧集和电影系列文件夹
- **扫描优化**：改为只扫描第一层目录，大幅提升扫描速度
- **TMDB 优化**：添加频率限制和重试机制，解决 SSL 连接错误
- **界面改进**：区分文件和文件夹的显示，更清晰的状态展示

### v1.0.0

- 初始版本发布
- 实现基本的文件扫描和分类功能
- 集成 TMDB API 和 qBittorrent API
- 提供现代化 Web 界面
